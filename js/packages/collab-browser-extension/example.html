<html>
  <body>
  </body>
  <script type='text/javascript'>
    function startBeacon(event) {
      window.postMessage({
        type: 'FROM_PAGE',
        requiredViewportSize: {
          width: 800,
          height: 600,
        },
        designId: '12345',
      }, '*')
      event.target.disabled = true
    }
    let extensionLoaded
    const loop = setInterval(() => {
      extensionLoaded = document.querySelector('#applitools-collab-extension-loaded')
      if (extensionLoaded) {
        console.log('extension loaded!')
        const trigger = document.createElement('button')
        trigger.append(document.createTextNode('Click me'))
        document.body.appendChild(trigger)
        document.querySelector('button').addEventListener('click', startBeacon, false)
        clearInterval(loop)
      } else {
        console.log('extension not loaded...')
        if (/chrome|chromium|crios/i.test(navigator.userAgent)) {
          console.log('chrome detected, adding install link')
          const trigger = document.createElement('a')
          trigger.href = 'https://chrome.google.com/webstore/category/extensions'
          trigger.target = '_blank'
          trigger.append(document.createTextNode('Install the extension'))
          document.body.appendChild(trigger)
        } else {
          console.log('unsupported browser, nothing to do.')
        }
        clearInterval(loop)
      }
    }, 0)
    window.addEventListener('message', (event) => {
      // We only accept messages from ourselves
      if (event.source != window) {
        return
      }

      if (event.data.type && (event.data.type == 'FROM_EXTENSION')) {
        console.log('received data from the extension', event.data)
        if (event.data.screenshot) {
          document.querySelector('button').disabled = false
          const payload = document.createElement('div')
          payload.append(document.createTextNode(event.data.screenshot))
          document.body.appendChild(payload)
        }
      }
    }, false)
  </script>
</html>
